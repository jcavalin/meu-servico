<script>
import { LocalStorage } from 'quasar'
import { Feriados } from './Feriados'
import { Util } from './Util'
import moment from 'moment'

export default {

}
export const Servicos = {
  key: 'servicos',
  set: function (servicos) {
    LocalStorage.set(this.key, servicos)
  },
  get: function () {
    let servicos = LocalStorage.get.item(this.key)
    servicos = servicos || []
    return servicos
  },
  getById: function (id) {
    let servicoEncontrado = null
    this.get().forEach(function (servico) {
      if (servico.id === id) {
        servicoEncontrado = servico
        return servicoEncontrado
      }
    })

    return servicoEncontrado
  },
  add: function (servico) {
    servico.id = Util.generateId()
    let servicos = this.get()
    servicos.push(servico)
    this.set(servicos)
  },
  update: function (servicoUpdate) {
    let servicos = this.get()
    let servicosObj = this
    servicos.forEach(function (servico, index) {
      if (servico.id === servicoUpdate.id) {
        servicos[index] = servicoUpdate
        servicosObj.set(servicos)
        return servico
      }
    })
  },
  delete: function (id) {
    let servicos = this.get()
    let servicosObj = this
    servicos.forEach(function (servico, index) {
      if (servico.id === id) {
        servicos.splice(index, 1)
        servicosObj.set(servicos)
        return servico
      }
    })
  },
  calcularProximosServicos (servico) {
    let calcularProximoServico = this.calcularProximoServico
    let servicos = this.get()

    let montarServico = function (servico, data) {
      return {
        id: Util.generateId(),
        servicoPai: servico.id,
        title: servico.title,
        folga: servico.folga,
        startDate: data,
        classes: servico.classes
      }
    }

    if (servico.title) {
      let ultimoServico = servico

      while (moment().add(1, 'years').isAfter(ultimoServico.startDate)) {
        ultimoServico = montarServico(ultimoServico, calcularProximoServico(ultimoServico))
        servicos.push(ultimoServico)
      }
    }

    this.set(servicos)
    return servicos
  },
  calcularProximoServico (servico) {
    let calcularPreta = function (servico) {
      let qtdDias = 1
      let dataAtual = moment(servico.startDate).add(1, 'days')
      let diaSemana = dataAtual.weekday()

      while (qtdDias <= servico.folga || diaSemana === 0 || diaSemana === 6 || Feriados.is(dataAtual)) {
        if (diaSemana !== 0 && diaSemana !== 6 && !Feriados.is(dataAtual)) {
          qtdDias++
        }

        dataAtual = moment(dataAtual).add(1, 'days')
        diaSemana = dataAtual.weekday()
      }

      return dataAtual.toDate()
    }

    let calcularVermelha = function (servico) {
      let qtdDias = 1
      let dataAtual = moment(servico.startDate).add(1, 'days')
      let diaSemana = dataAtual.weekday()
      while (qtdDias <= servico.folga || (diaSemana !== 0 && diaSemana !== 6 && !Feriados.is(dataAtual))) {
        if (diaSemana === 0 || diaSemana === 6 || Feriados.is(dataAtual)) {
          qtdDias++
        }

        dataAtual = moment(dataAtual).add(1, 'days')
        diaSemana = dataAtual.weekday()
      }

      return dataAtual.toDate()
    }

    let dataProximoServico = null
    switch (servico.classes) {
      case 'preta' :
        dataProximoServico = calcularPreta(servico)
        break
      case 'vermelha' :
        dataProximoServico = calcularVermelha(servico)
        break
    }

    return dataProximoServico
  }
}
</script>